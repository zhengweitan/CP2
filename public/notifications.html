<!-- notifications.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - ASVMS</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Reuse your sidebar from respective dashboard -->

    <div class="main-content">
        <div class="top-bar">
            <a href="javascript:history.back()" class="back-button">‚Üê Back</a>
            <div class="search-bar">
                <span>üîç</span>
                <input type="text" placeholder="Search notifications..." id="notification-search">
            </div>
        </div>

        <h1 class="dashboard-title">Notifications</h1>

        <div class="notification-actions">
            <button onclick="markAllAsRead()">Mark All as Read</button>
        </div>

        <div class="notifications-container" id="notifications-container">
            <!-- Notifications will load here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications();
            
            // Search functionality
            document.getElementById('notification-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                document.querySelectorAll('.notification-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
                });
            });
        });

function loadNotifications() {
    const userId = sessionStorage.getItem('userId');
    fetch(`/notifications?userId=${userId}`)
        .then(res => res.json())
        .then(notifications => {
            const container = document.getElementById('notifications-container');
            
            if (notifications.length === 0) {
                container.innerHTML = '<p class="no-notifications">No notifications found</p>';
                return;
            }
            
            container.innerHTML = notifications.map(notif => `
                <div class="notification-item ${notif.is_read ? '' : 'unread'}">
                    <div class="notification-message">${notif.message}</div>
                    <div class="notification-meta">
                        <span class="notification-time">${formatTime(notif.created_at)}</span>
                        ${notif.is_read ? '' : 
                            `<div class="notification-actions">
                                <button class="btn-mark-read" onclick="markAsRead(${notif.id}, this)">
                                    Mark as read
                                </button>
                            </div>`}
                    </div>
                </div>
            `).join('');
        });
}

function markAsRead(id, button) {
    fetch(`/notifications/${id}/read`, { method: 'POST' })
        .then(() => {
            const item = button.closest('.notification-item');
            item.classList.remove('unread');
            item.querySelector('.notification-actions').remove();
            updateUnreadCount();
        });
}

function updateUnreadCount() {
    const userId = sessionStorage.getItem('userId');
    fetch(`/notifications/unread-count?userId=${userId}`)
        .then(res => res.json())
        .then(data => {
            const badge = document.getElementById('unread-badge');
            if (badge) {
                badge.textContent = data.count;
                badge.style.display = data.count > 0 ? 'inline-block' : 'none';
            }
        });
}

        function markAllAsRead() {
            const userId = sessionStorage.getItem('userId');
            fetch(`/notifications/mark-all-read?userId=${userId}`, { method: 'POST' })
                .then(() => {
                    loadNotifications();
                    loadNotificationPreview();
                });
        }

        // Format time function
function formatTime(timestamp) {
    if (!timestamp) return 'Just now';
    
    const date = new Date(timestamp);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) return 'Just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} min ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hour${diffInSeconds > 7200 ? 's' : ''} ago`;
    
    // For older than 24 hours, show date and time
    const options = {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    return date.toLocaleDateString('en-US', options);
}
    </script>
</body>
</html>